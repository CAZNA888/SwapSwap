# Инструкция по настройке LevelManager

## Обзор

`LevelManager` управляет всеми уровнями игры: загружает картинки для уровней, рассчитывает размерность сетки, определяет сложные уровни. Поддерживает два режима работы:

1. **Unity режим** (по умолчанию) - использование спрайтов напрямую из Unity
2. **Addressables режим** - асинхронная загрузка картинок через Addressables

---

## Режим 1: Работа без Addressables (Unity режим)

### Преимущества

- ✅ Простая настройка
- ✅ Не требует установки дополнительных пакетов
- ✅ Мгновенная загрузка спрайтов
- ✅ Идеально для разработки и тестирования

### Настройка

#### Шаг 1: Добавьте LevelManager на сцену

1. Откройте сцену с игрой
2. В иерархии найдите или создайте GameObject (например, "Managers")
3. Добавьте компонент `LevelManager`:
   - Выберите GameObject
   - В Inspector нажмите "Add Component"
   - Найдите и добавьте "Level Manager"

#### Шаг 2: Настройте параметры LevelManager

В Inspector найдите компонент `Level Manager` и настройте:

**Image Loading:**

- ✅ **Use Addressables**: `false` (снимите галочку)
- **Level Images**: Нажмите "+" и добавьте элементы в список

**Для каждого элемента Level Images:**

- **Name**: Введите название картинки (например, "Level_1", "Nature", "City")
- **Sprite**: Перетащите спрайт из Project window
- **Addressable Key**: Оставьте пустым (не используется в Unity режиме)

**Пример настройки:**

```
Level Images:
  [0] Name: "Nature_1", Sprite: [NatureSprite1]
  [1] Name: "Nature_2", Sprite: [NatureSprite2]
  [2] Name: "City_1", Sprite: [CitySprite1]
  ...
```

#### Шаг 3: Настройте параметры размерности сетки

**Grid Size Settings:**

- **Start Grid Size**: `3` (стартовая размерность 3x3)
- **Grid Size Increase Period**: `5` (каждые 5 уровней размерность увеличивается на 1)
- **Max Grid Size**: `8` (максимальная размерность 8x8)

**Пример прогрессии:**

- Уровни 0-4: 3x3
- Уровни 5-9: 4x4
- Уровни 10-14: 5x5
- И так далее до 8x8

#### Шаг 4: Настройте сложные уровни (опционально)

**Difficult Level Settings:**

- **Difficult Level Period**: `3` (каждые 3 уровня выпадает сложный уровень)
- **Difficult Level UI Object**: Перетащите GameObject, который будет показываться в начале сложного уровня
- **Difficult Level Display Duration**: `3` (время показа в секундах)

**Примечание:** Сложный уровень имеет увеличенную размерность на +1 и показывает UI объект в начале.

#### Шаг 5: Настройте GameManager

В `GameManager` компоненте:

- **Source Image**: Оставьте пустым (будет устанавливаться автоматически)
- **Grid Rows**: Оставьте `0` (будет рассчитываться автоматически)
- **Grid Cols**: Оставьте `0` (будет рассчитываться автоматически)

### Готово!

Теперь LevelManager будет автоматически:

- Загружать картинки из массива `levelImages` по индексу уровня
- Рассчитывать размерность сетки в зависимости от уровня
- Показывать UI сложного уровня, если это сложный уровень
- Увеличивать уровень после прохождения

---

## Режим 2: Работа с Addressables

### Преимущества

- ✅ Оптимизация памяти (загрузка только нужных ресурсов)
- ✅ Возможность обновления контента без обновления приложения
- ✅ Лучшая организация ресурсов
- ✅ Поддержка удаленной загрузки

### Установка Addressables

#### Шаг 1: Установите пакет Addressables

1. Откройте **Window > Package Manager**
2. В левом верхнем углу выберите **Unity Registry**
3. Найдите **Addressables** в списке
4. Нажмите **Install**

Или через manifest.json:

```json
{
  "dependencies": {
    "com.unity.addressables": "1.21.19"
  }
}
```

#### Шаг 2: Настройте Addressables Groups

1. Откройте **Window > Asset Management > Addressables > Groups**
2. Создайте новую группу (если нет): **Create > Addressables Group**
3. Назовите группу, например: **"LevelImages"**

#### Шаг 3: Добавьте спрайты в Addressables

**Вариант A: Через Inspector**

1. Выберите спрайт в Project window
2. В Inspector найдите **Addressable** чекбокс
3. Отметьте галочку
4. В появившемся поле введите ключ (например: `"LevelImage_Nature_1"`)
5. Выберите группу (например: **"LevelImages"**)

**Вариант B: Перетащите в группу**

1. Откройте Addressables Groups window
2. Перетащите спрайты из Project window в группу
3. Ключи сгенерируются автоматически (можно изменить)

#### Шаг 4: Настройте LevelManager

**Image Loading:**

- ✅ **Use Addressables**: `true` (отметьте галочку)
- **Level Images**: Добавьте элементы в список

**Для каждого элемента Level Images:**

- **Name**: Введите название (например, "Nature_1")
- **Sprite**: Может быть пустым (не используется в Addressables режиме)
- **Addressable Key**: Введите ключ Addressable (например, `"LevelImage_Nature_1"`)

**Важно:** Ключ должен точно совпадать с ключом в Addressables Groups!

**Пример настройки:**

```
Level Images:
  [0] Name: "Nature_1", Addressable Key: "LevelImage_Nature_1"
  [1] Name: "Nature_2", Addressable Key: "LevelImage_Nature_2"
  [2] Name: "City_1", Addressable Key: "LevelImage_City_1"
  ...
```

**Автогенерация ключей:**
Если `Addressable Key` пуст, он будет сгенерирован автоматически как: `"LevelImage_" + Name`

#### Шаг 5: Настройте параметры (как в Unity режиме)

Настройте **Grid Size Settings** и **Difficult Level Settings** так же, как описано в режиме 1.

#### Шаг 6: Соберите Addressables (для билда)

1. Откройте **Window > Asset Management > Addressables > Groups**
2. Нажмите **Build > New Build > Default Build Script**
3. Дождитесь завершения сборки

**Примечание:** Для локальной разработки сборка не обязательна, но рекомендуется для тестирования.

### Готово!

Теперь LevelManager будет:

- Асинхронно загружать картинки через Addressables
- Использовать ключи из массива `levelImages`
- Работать так же, как в Unity режиме, но с асинхронной загрузкой

---

## Переключение между режимами

### С Unity на Addressables

1. Установите пакет Addressables (см. выше)
2. Добавьте спрайты в Addressables Groups
3. В LevelManager:
   - Отметьте **Use Addressables**: `true`
   - Заполните **Addressable Key** для каждого элемента
4. Перезапустите сцену

### С Addressables на Unity

1. В LevelManager:
   - Снимите галочку **Use Addressables**: `false`
   - Заполните **Sprite** для каждого элемента
2. Перезапустите сцену

---

## Структура данных LevelImageData

Каждый элемент в массиве `levelImages` содержит:

```csharp
[System.Serializable]
public class LevelImageData
{
    public string name;              // Название для отладки
    public Sprite sprite;           // Для Unity режима
    public string addressableKey;    // Для Addressables режима
}
```

**Логика выбора картинки:**

- Картинка выбирается по формуле: `imageIndex = currentLevel % levelImages.Count`
- Это означает, что картинки циклически повторяются

**Пример:**

- Если у вас 3 картинки в массиве:
  - Уровень 0 → картинка 0
  - Уровень 1 → картинка 1
  - Уровень 2 → картинка 2
  - Уровень 3 → картинка 0 (цикл)
  - Уровень 4 → картинка 1
  - И так далее

---

## Расчет размерности сетки

### Формула

```
baseSize = startGridSize (по умолчанию 3)
increase = currentLevel / gridSizeIncreasePeriod
gridSize = baseSize + increase

Если это сложный уровень:
  gridSize += 1

Ограничение:
  gridSize = min(gridSize, maxGridSize)
```

### Примеры

**Настройки:**

- Start Grid Size: 3
- Grid Size Increase Period: 5
- Max Grid Size: 8
- Difficult Level Period: 3

**Результат:**

- Уровень 0: 3x3 (обычный)
- Уровень 1: 3x3 (обычный)
- Уровень 2: 3x3 (обычный)
- Уровень 3: 4x4 (сложный: 3 + 0 + 1)
- Уровень 4: 3x3 (обычный)
- Уровень 5: 4x4 (обычный: 3 + 1)
- Уровень 6: 4x4 (обычный)
- Уровень 8: 5x5 (сложный: 3 + 1 + 1)
- Уровень 10: 5x5 (обычный: 3 + 2)
- И так далее до 8x8

---

## Сложные уровни

### Что такое сложный уровень?

Сложный уровень - это уровень, который:

1. Имеет увеличенную размерность сетки на +1
2. Показывает специальный UI объект в начале уровня на заданное время

### Настройка

1. **Difficult Level Period**: Периодичность (каждые N уровней)
2. **Difficult Level UI Object**: GameObject для показа (может быть панель с текстом "Сложный уровень!")
3. **Difficult Level Display Duration**: Время показа в секундах

### Пример UI объекта

Создайте GameObject с:

- Canvas (если UI элемент)
- Image или TextMeshPro для текста "Сложный уровень!"
- Анимация появления/исчезновения (опционально)

---

## Отладка

### Проверка текущего уровня

В консоли Unity вы увидите сообщения:

```
LevelManager: Level incremented to 1
LevelManager: Level: 1, Grid Size: 3x3, Difficult: false
```

### Проверка загрузки картинок

**Unity режим:**

- Если спрайт не загружен, в консоли будет ошибка:
  ```
  LevelManager: Sprite is null for level X, image index Y
  ```

**Addressables режим:**

- Если ключ не найден, в консоли будет ошибка:
  ```
  LevelManager: Failed to load image from Addressables with key 'LevelImage_XXX'
  ```

### Методы для отладки

В LevelManager доступны методы:

- `GetCurrentLevel()` - текущий уровень
- `CalculateGridSize()` - размерность сетки
- `IsDifficultLevel()` - является ли уровень сложным
- `GetLevelInfo()` - информация о текущем уровне

---

## Часто задаваемые вопросы

### Q: Можно ли использовать оба режима одновременно?

**A:** Нет, работает только один режим в зависимости от флага `useAddressables`.

### Q: Что делать, если Addressables не установлены?

**A:** Используйте Unity режим (`useAddressables = false`). Код автоматически определит отсутствие Addressables и будет работать только в Unity режиме.

### Q: Как сбросить уровень?

**A:** В коде или через консоль:

```csharp
LevelManager.Instance.SetLevel(0);
```

Или через PlayerPrefs:

```csharp
PlayerPrefs.DeleteKey("CurrentLevel");
```

### Q: Можно ли использовать разные картинки для разных уровней?

**A:** Да, просто добавьте больше элементов в массив `levelImages`. Картинки будут циклически повторяться.

### Q: Как изменить логику выбора картинок?

**A:** Измените формулу в методе `GetLevelImage()`:

```csharp
int imageIndex = currentLevel % levelImages.Count; // Текущая формула
```

### Q: Нужно ли собирать Addressables для разработки?

**A:** Для локальной разработки сборка не обязательна, но рекомендуется для тестирования реального поведения.

---

## Рекомендации

### Для разработки

- Используйте **Unity режим** для быстрой итерации
- Заполните массив `levelImages` тестовыми спрайтами
- Настройте параметры размерности для тестирования

### Для продакшена

- Используйте **Addressables режим** для оптимизации
- Организуйте спрайты в логические группы
- Соберите Addressables перед билдом
- Протестируйте загрузку на разных устройствах

---

## Поддержка

Если возникли проблемы:

1. Проверьте консоль Unity на наличие ошибок
2. Убедитесь, что все поля заполнены корректно
3. Проверьте, что ключи Addressables совпадают
4. Убедитесь, что LevelManager добавлен на сцену

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Автор:** AI Assistant





